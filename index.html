---
title: "Goa style classifier"
author: "Tamas Nagy"
date: "10/24/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(tidyverse)
library(rvest)
library(spotifyr)
knitr::opts_chunk$set(echo = TRUE)
theme_set(theme_light())

```

Authenticate spotify API

```{r}
spotify_id <- read_csv("spotify_client_id.txt")

Sys.setenv(SPOTIFY_CLIENT_ID = spotify_id$client_id)
Sys.setenv(SPOTIFY_CLIENT_SECRET = spotify_id$secret)

access_token <- get_spotify_access_token()
```

Get data from <http://psytranceguide.com/>

```{r}
psytrance_link <- "http://psytranceguide.com/"
psytrance_page <- read_html(psytrance_link)


```

This part downloads all mp3-s locally (maybe not needed)

```{r}
# Download the html for the hompage
download.file("http://psytranceguide.com/", 
              destfile = "psyctrance.html")

# Read html
psytrance_html <- read_lines("psyctrance.html")

# Select the mp3-s, get links
mp3_links <-
  psytrance_html %>% 
  tibble(line = .) %>% 
  filter(str_detect(line, ".mp3")) %>% 
  transmute(file = str_match(line, "audio/.*.mp3"), 
            link = str_glue("{psytrance_link}{file}"))

dir.create("audio")

walk2(mp3_links$link, 
      mp3_links$file,
      ~download.file(.x, destfile = .y))
  

```

Create a dataset that contains genre data and track features

```{r}
# Get the urls and other data from the psytrance guide
goa_data <- 
  psytrance_page %>% 
  html_nodes("h2 a , .jouele-info-control-text")

# Get all music features for all tracks for each playlist
features <- map_dfr(goa_genres$playlist_id, 
                    ~get_playlist_audio_features(playlist_uris = .x))

# Create a table for all data
goa_genres <-
  tibble(genre = map_chr(goa_data, html_text),
         playlist_url = html_attr(goa_data, "href")) %>% 
  extract(playlist_url, 
          into = "playlist_id", 
          regex = ".*playlist/(.*)\\?si.*") 

# Put playlist information and features together
goa <- 
  left_join(goa_genres, features, by = "playlist_id") %>% 
  hoist(track.album.artists, "name", .remove = TRUE) %>% 
  select(genre:playlist_name, 
         track_id = track.id, track_name = track.name, 
         artist_names = name,
         danceability:tempo)

```

```{r}
library(tidymodels)


```
